% Script demonstrating usage of the varsplit_test function.


% Training images
S0 = imresize(single(stdimage('lena.grey'))/255,.5) ;


% Add Salt and Pepper
% Sn = S0;
% Sn(250:260,250:260) = 1;
Sn = imnoise(S0, 'salt & pepper');




% Highpass filter test image

npd = 16;
fltlmbd = 5;
[sl, sh] = lowpass(s, fltlmbd, npd);
shn = sh;
opt = [];
I = randi(255,2,ceil(256*256*.08));
opt.L2Weights = ones(256,256);
for i = 1:size(I,2)
    opt.L2Weights(I(1,i),I(2,i)) = 0;
    shn(I(1,i),I(2,i)) = 1;
end


% Filter input images and compute highpass images
npd = 16;
fltlmbd = 10;
[Sl, Sh] = lowpass(S0, fltlmbd, npd);
[Sln, Shn] = lowpass(Sn, fltlmbd, npd);

Sn = imnoise(S0, 'salt & pepper');
for i = [2,2,2,2,2]
  [Sl, Sh] = lowpass(Sn, i, npd);
  Sn = Sl;
  figure;
  imagesc(Sh);
end


% Load a standard dictionary
load([sporco_path '/Data/ConvDict.mat']);
dmap = containers.Map(ConvDict.Label, ConvDict.Dict);
D = dmap('8x8x32');
delta = zeros(8,8);
delta(1,1) = 1;
D(:,:,end+1) = delta;


lambda = .02;
opt.Verbose = 1;
opt.MaxMainIter = 200;
opt.rho = 100*lambda + 1;
opt.RelStopTol = 1e-3;
opt.AuxVarObj = 0;
opt.HighMemSolve = 1;
opt.L1Weight = [ones(1,32),.8];
opt.L1Weight = reshape(opt.L1Weight,1,1,33);

[X,~] = cbpdn(D,Shn,lambda,opt);
% opt.L1Weight = 1;
% [X_clean,~] = cbpdn(D(:,:,1:1:32),Sh,lambda,opt);



figure;
title('Lowpass');
imagesc(Sln);

Sh_rec = convsum(D,X,1:1:32);
Sh_clean = convsum(D,X_clean,1:1:32);

figure;
title('Reconstructed High Freq');
imagesc(Sh_rec);

S_rec = Sh_rec + Sln;

figure;
p = psnr(S_rec,S0);
imagesc(S_rec);
title(['psnr of rec= ', num2str(p)]);

% figure;
% p = psnr(Sh_clean+Sl,S0);
% imagesc(Sl+Sh_clean);
% title(['psnr of clean recreation = ' num2str(p)]);




% temp = zeros(size(X,1),size(X,2),32);
% for i = 1:32
%     temp(:,:,i) = convsum(D,X,i);
%     figure;
%     imagesc(temp(:,:,i));
% end
     









