%code for testing Averaging Effect of a spatial gradient term. 


%%%%%%%%%%%%%%%%%%%%%%%%% data generation%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %pure noise 
% s = .1*randn(imsz,imsz); 
% s_ref = zeros(size(s));


% %pure noise 
% sn = .1*randn(imsz,imsz); 
% s_ref = zeros(size(sn));
% s = s_ref+sn;

%save('noise_data','s');

%lena
load('noise_data.mat');
s_ref = single(rgbtogrey(stdimage('lena')))/255;
s_ref = imresize(s_ref,.5);
s = s_ref+s;
imsz = size(s,1);


%%%%%%%%%%%%%%%%%%%%%%% preprocessing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[sl,sh] = lowpass(s,5,16);

% Construct initial dictionary
% Load dictionary
load([sporco_path '/Data/ConvDict.mat']);
dmap = containers.Map(ConvDict.Label, ConvDict.Dict);
D = dmap('12x12x36');


% Set up bpdndliu parameters
lambda = .15;
opt = [];
opt.Verbose = 1;
opt.rho = 100;
opt.MaxMainIter =150;
opt.RelStopTol = 1e-3;




%%%%%%%%%%%%%%%%%%%%%%%%%%%% Processing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Running optimization
[x1, ~] = cbpdn(D, sh, lambda, opt);
[x2,~] = cbpdngr(





%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Post processing%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% reconstructing patch
s_rec1 = D1d*x1;
s_rec = bsxfun(@plus,s_rec1,s_flat_mean);
srec_patch = unpatchify(s_rec, patchSize, stepSize, [imsz,imsz]);
srec_high = unpatchify(s_rec1, patchSize, stepSize, [imsz,imsz]);

% reconstructing conv
scnv = @(d,x) ifft2(sum(bsxfun(@times, fft2(d, size(x,1), size(x,2)), ...
                               fft2(x)),3), 'symmetric');
srec_conv = scnv(D,x2)+sl;

% plotting
figure;
subplot(1,2,1);
imagesc(s_ref);
title('Original');
colorbar;
subplot(1,2,2);
imagesc(s);
title('Noisy');
colorbar;
saveas(gcf,['DenoiseResult/',tag,'rawim'],'fig');


figure;
subplot(1,2,1);
imagesc(srec_high);
title('Highfreq-patch');
colorbar;
subplot(1,2,2);
imagesc(srec_conv-sl);
title('Highfreq-conv');
colorbar;
saveas(gcf,['DenoiseResult/',tag,'Highfreq'],'fig');



figure;
subplot(1,2,1);
imagesc(srec_patch-srec_high);
title('Lowfreq-patch');
colorbar;
subplot(1,2,2);
imagesc(sl);
title('Lowfreq-conv');
colorbar;
saveas(gcf,['DenoiseResult/',tag,'Lowfreq'],'fig');



figure;
subplot(1,2,1);
imagesc(srec_patch);
title('Recon-patch');
colorbar;
subplot(1,2,2);
imagesc(srec_conv);
title('Recon-conv');
colorbar;
saveas(gcf,['DenoiseResult/',tag,'Recon'],'fig');

figure;
subplot(1,2,1);
imagesc(srec_patch-s_ref);
title('Diff-patch');
colorbar;
subplot(1,2,2);
imagesc(srec_conv-s_ref);
title('Diff-conv');
colorbar;
saveas(gcf,['DenoiseResult/',tag,'Diff'],'fig');