function [ Y_bar ] = eiglasso( phi, E, Z,lambda,mu, rho,opt)
% solve the Lasso problem via eigenvector decomposition
%         argmin_{Y} (mu/2)Y'LY + (rho/2) ||Y-Z||^2
%                           lambda \sum_k ||Y||_1
% via ADMM. Spatial coordinates should be flattened before using.
% L is symmetric semi-positive definite, having rank r
% phi: (m_k x n_k) x r matrix, top r eigenvector of the matrix L
% E: length r vector,  top r eigenvalues of L
% Z: Load vector (m_k x n_k) x m
% lambda, mu: penalty parameters
% rho: stepsize for ADMM


if(isfield(opt,'Y_bar'))
    Y_bar = opt.Y_bar;
else
    Y_bar = zeros(size(Z));
end

if(isfield(opt,'V'))
    V = opt.V;
else
    V = zeros(size(Z));
end

if(opt.verbose == 1)
    hstr = 'Itn   Fnc       DFid      l1        r         s    ';
    sfms = '%4d %9.2e %9.2e %9.2e %9.2e %9.2e %9.2e';
    nsep = 54;
    flag = 1;
end



k = 0;
A = .5*(Z+Y_bar-V);
A_hat = phi'*A;
A_par = phi*A_hat; %project Z onto nontrivial eigenspace
A_perp = A-A_par; %perpendicular part

while (k< opt.maxiter)
    Y_par = A_hat./(mu*E+2*rho)*2*rho; % Y_par update
    Y = Y_par + A_perp;
    Y_bar = shrink(Y + V, lambda/rho);
    V = Y-Y_bar+V;
    A = .5*(Z+Y_bar-V);  
    A_hat = phi'*A;
    if flag,
        Jf = 
end




end


function u = shrink(v, lambda)

  if isscalar(lambda),
    u = sign(v).*max(0, abs(v) - lambda);
  else
    u = sign(v).*max(0, bsxfun(@minus, abs(v), lambda));
  end

return
end


