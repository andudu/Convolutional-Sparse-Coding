
%%%%%%%%%%%%%%%%%%%%%%%%%%%  Load  Data %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%load a saved noise
load('noise_data.mat');
snoise = s;
% snoise = randn(256,256)*.1;
s_ref = single(stdimage('lena.grey')) / 255;
s_ref = imresize(s_ref,.5);
s = s_ref+snoise;
wsz = [60,60];
psz = [12,12];
neig = 30;
[sl,sh] = lowpass(s,5,15);
[L,sh] = graphgen(sh,wsz,psz,neig);
disp('graph generated');
sl = sl(1:size(sh,1),1:size(sh,2));
sref = sref(1:size(sh,1),1:size(sh,2));


% Load dictionary
load([sporco_path '/Data/ConvDict.mat']);
dmap = containers.Map(ConvDict.Label, ConvDict.Dict);
D = dmap('12x12x36');



%%%%%%%%%%%%%%%%%%%%%%% set up parameters %%%%%%%%%%%%%%%%%%%%%%%%%%%%

mu_all = 0.1:0.1:1;
opt = {};
opt.Verbose = 0;
opt.MaxMainIter = 500;
opt.rho = 100*lambda + 1;
opt.RelStopTol = 1e-3;
opt.AuxVarObj = 0;
opt.HighMemSolve = 1;

%optimize
lambda_all = 0.15:0.01:0.3;


%%%%%%%%%%%%%%%%%%%%%%%%%%%% optimizing over all param %%%%%%%%%%%%%%%%%%%%
% reconstructing conv
scnv = @(d,x) ifft2(sum(bsxfun(@times, fft2(d, size(x,1), size(x,2)), ...
                               fft2(x)),3), 'symmetric');

pcn_rec = zeros(size(lambda_all));
pnl_rec = zeros(length(lambda_all), length(mu_all));
pcn_max = 0;
pnl_max = 0;
lambdacn_max = 0;
lambdanl_max = 0;
munl_max = 0;



for i = 1:length(lambda_all)
    disp([num2str(i),' out of ',num2str(length(lambda_all))]);
    lambda = lambda_all(i);
    [Xcn,~] = cbpdn(D,sh,lambda,opt);
    shreccn = scnv(D,Xcn);
    sreccn = shreccn+sl;
    p_cn = psnr(sreccn,sref);
    
    if p_cn > pcn_max,
        pcn_max = p_cn;
        lambdacn_max = lambda;
    end
    
    for j = 1:length(mu_all)
        mu = mu_all(j);
        [Xnl,~]= cbpdn_L(D,sh,L,lambda,mu,opt);
        shrecnl = scnv(D,Xnl);
        srecnl = shrecnl+sl;
        p_nl = psnr(srecnl,sref);
        
        if p_nl < pnl_max
            pnl_max = pnl;
            lambdanl_max = lambda;
            munl_max = mu;
        end
    end
end


save(['ParamNL/',tag],'pcn_rec','pnl_rec','pcn_max','pnl_max','lambdacn_max','lambda



